@using FirstTask.Handlers;

@{
	var localizer = new LocalizHandler();
	ViewBag.Title = localizer.GetValue("HeadingCompanies");
}

<h2>@localizer.GetValue("HeadingCompanies")</h2>

<span id="companyNotifications"></span>

<div class="container">
	<div id="companiesGrid">
		<div id="companiesToolbar">
			<p>@localizer.GetValue("FilterStatus")</p>
			<div id="statusesListCompanies"></div>
			<p>@localizer.GetValue("FilterSorting")</p>
			<div id="companiesSortingTypes"></div>
			<p>@localizer.GetValue("FilterName")</p>
			<input type="text" name="Name" id="nameFilter" />
			<button type="button" id="btnCompanySearch">@localizer.GetValue("ButtonSearch")</button>
		</div>
	</div>

	<div id="companiesInsertWindow">
		<form id="companiesInsertForm"></form>
	</div>

	<div id="companyEditWindow">
		<form id="companyEditForm"></form>
	</div>

	<div>
		<div id="companiesDeleteWindow" style="text-align: center; display: none;">
			<h3 style="margin: 20px 0px;">@localizer.GetValue("DeleteWarningMessage")</h3>
		</div>
	</div>
</div>

<script type="text/javascript">
	$(document).ready(function () {

		var notifElement = $("#companyNotifications");
		notifElement.kendoNotification({
		});

		var notification = notifElement.data("kendoNotification");

		// Insert

		$("body").on("click", "#companiesCloseInsertWindow", function () {
			$("#companiesInsertWindow").data("kendoDialog").close();
		});

		$("body").on("click", "#companiesCloseEditWindow", function () {
			$("#companyEditWindow").data("kendoDialog").close();
		});

		$("#companiesInsertWindow").kendoDialog({
			modal: true,
			width: "700px",
			closable: false,
			visible: false,
			title: false,
		});

		$("body").on("click", "#btnCompanyInsert", function () {
			let window = $("#companiesInsertWindow").data("kendoDialog")
			window.open();
		});

		var formInsert = $("#companiesInsertForm").kendoForm({
			visible: false,
			items: [
				{
					type: "group",
					label: "@localizer.GetValue("CompanyInsertFormHeader")",
					items: [
						{
							field: "Name", label: "@localizer.GetValue("LabelName")", placeholder: "@localizer.GetValue("PlaceholderName")",
							editor: function (container, options) {
								var input = $('<input id="insertCompaniesName" name="Name"/>');
								input.appendTo(container);
								input.kendoTextBox();
							}
						},
						{
							field: "DateOfBegin", label: "@localizer.GetValue("LabelDateOfBegin")",
							editor: function (container, options) {
								var input = $('<input id="insertDate" name="DateOfBegin" />');
								input.appendTo(container);
								input.kendoDatePicker({
									placeholder: "@localizer.GetValue("PlaceholderDateOfBegin")",
									format: 'dd/MM/yyyy'
								});
							}
						},
						{
							field: "BIN", label: "@localizer.GetValue("LabelBIN")",
							editor: function (container, options) {
								var input = $('<input name="BIN" />');
								input.appendTo(container);
								input.kendoMaskedTextBox({
									placeholder: "@localizer.GetValue("PlaceholderBIN")",
									mask: "000-000-000-000"
								});
							}
						},
						{
							field: "Phone", label: "Телефон", editor: function (container, options) {
								var input = $('<input name="Phone"/>');
								input.appendTo(container);
								input.kendoMaskedTextBox({
									placeholder: "@localizer.GetValue("PlaceholderPhone")",
									mask: "0-(000)-000-00-00"
								});
							}
						},
						{
							field: "Validator", label: "",
							editor: function (container, options) {
								var block = $('<div class="validateContainer"/>');
								block.appendTo(container);
							}
						}
					]
				}
			],
			buttonsTemplate: "<div class='form-buttons'><button class='btn-success' type='submit'>@localizer.GetValue("ButtonSave")</button> <button class='btn-danger' id='companiesCloseInsertWindow' type='button'>@localizer.GetValue("ButtonCancellation")</button></div>"
		});
		// Insert Validator and Submit
		$("#companiesInsertForm").validate({
			rules: {
				Name: {
					required: true,
					minlength: 6,
				},
				BIN: {
					required: true,
					pattern: "^[0-9]{3}-[0-9]{3}-[0-9]{3}-[0-9]{3}$"
				},
				DateOfBegin: {
					required: true,
					dateFilter: true,
					pastDate: true
				},
				Phone: {
					required: true,
					pattern: "^[0-9]-[(]?[0-9]{3}[)]?-[0-9]{3}-[0-9]{2}-[0-9]{2}$"
				}
			},
			messages: {
				Name: {
					required: "@localizer.GetValue("LabelName"): @localizer.GetValue("ValidationMessageInputRequired")",
					minlength: "@localizer.GetValue("ValidationMessageMinLenght") 6",
				},
				BIN: {
					required: "@localizer.GetValue("LabelBIN"): @localizer.GetValue("ValidationMessageInputRequired")",
					pattern: "@localizer.GetValue("LabelBIN"): @localizer.GetValue("ValidationMessageFormatError") 'XXX-XXX-XXX-XXX'"
				},
				DateOfBegin: {
					required: "@localizer.GetValue("LabelDateOfBegin"): @localizer.GetValue("ValidationMessageInputRequired")",
					dateFilter: "@localizer.GetValue("LabelDateOfBegin"): @localizer.GetValue("ValidationMessageFormatError") 'ДД.ММ.ГГГГ'",
					pastDate: "@localizer.GetValue("ValidationMessageDateNonCorrect")"
				},
				Phone: {
					required: "@localizer.GetValue("LabelPhone"): @localizer.GetValue("ValidationMessageInputRequired")",
					pattern: "@localizer.GetValue("LabelPhone"): @localizer.GetValue("ValidationMessageFormatError") 'X-(XXX)-XXX-XX-XX'"
				}
			},
			focusInvalid: true,
			errorClass: "validationFormMessage",
			errorPlacement: function (error, element) {
				$(".validateContainer").empty();
				error.appendTo('.validateContainer');
			},
			submitHandler: function () {
				var data = formInsert.serializeArray();
				$.ajax({
					url: "/Company/AddCompany/",
					type: "POST",
					data: data,
					success: function (json) {
						if (json.IsSuccess == true) {
							var grid = $("#companiesGrid").data("kendoGrid");
							grid.dataSource.read();
							notification.success(json.Message);
							$('#companiesInsertForm')[0].reset();
							$("#companiesInsertWindow").data("kendoDialog").close();
						}
						else {
							notification.error(json.Error);
						}
					}
				});
			}
		});

		// Edit

		$("#companyEditWindow").kendoDialog({
			modal: true,
			width: "500px",
			closable: false,
			visible: false,
			title: false,
		});

		var formEdit = $("#companyEditForm").kendoForm({
			visible: true,
			items: [
				{
					field: "Name", label: "@localizer.GetValue("LabelName")", placeholder: "@localizer.GetValue("PlaceholderName")",
					editor: function (container, options) {
						var input = $('<input id="editCompaniesName" name="Name"/>');
						input.appendTo(container);
						input.kendoTextBox();
					}
				},
				{
					field: "DateOfBegin", label: "@localizer.GetValue("LabelDateOfBegin")",
					editor: function (container, options) {
						var input = $('<input id="editCompaniesDateOfBegin" name="DateOfBegin" />');
						input.appendTo(container);
						input.kendoDatePicker({
							placeholder: "@localizer.GetValue("PlaceholderDateOfBegin")",
							format: 'dd/MM/yyyy'
						});
					}
				},
				{
					field: "BIN", label: "@localizer.GetValue("LabelBIN")",
					editor: function (container, options) {
						var input = $('<input id="editCompaniesBin" name="BIN" />');
						input.appendTo(container);
						input.kendoMaskedTextBox({
							placeholder: "@localizer.GetValue("PlaceholderBIN")",
							mask: "000-000-000-000"
						});
					}
				},
				{
					field: "Phone", label: "@localizer.GetValue("LabelPhone")", editor: function (container, options) {
						var input = $('<input id="editCompaniesPhone" name="Phone"/>');
						input.appendTo(container);
						input.kendoMaskedTextBox({
							placeholder: "@localizer.GetValue("PlaceholderPhone")",
							mask: "0-(000)-000-00-00"
						});
					}
				},
				{
					field: "Validator", label: "",
					editor: function (container, options) {
						var block = $('<div class="validateContainer"/>');
						block.appendTo(container);
					}
				}
			],
			buttonsTemplate: "<button class='btn-success' type='submit'>@localizer.GetValue("ButtonSave")</button> <button class='btn-danger' id='companiesCloseEditWindow' type='button' class=''>@localizer.GetValue("ButtonCancellation")</button>"
		});


		function EditCompany(oldService) {
			var filteredBIN = EditBIN(oldService.BIN);
			var filteredDate = new Date(oldService.DateOfBegin).toLocaleDateString();
			var filteredPhone = EditNumber(oldService.Phone);

			$("#companyEditForm #editCompaniesId").val(oldService.Id);
			$("#companyEditForm #editCompaniesName").val(oldService.Name);
			$("#companyEditForm #editCompaniesBin").val(filteredBIN);
			$("#companyEditForm #editCompaniesDateOfBegin").val(filteredDate);
			$("#companyEditForm #editCompaniesPhone").val(filteredPhone);

			$("#companyEditWindow").data("kendoDialog").open();

			return false;
		}

		function ActivateCompany(id) {
			$.ajax({
				url: "/Company/ActivateCompany/",
				type: "POST",
				data: { id: id },
				success: function (json) {
					if (json.IsSuccess == true) {
						var grid = $("#companiesGrid").data("kendoGrid");
						grid.dataSource.read();
						notification.success(json.Message);
					}
					else {
						notification.error(json.Message);
					}
				}
			})
		}

		// Edit Validator and Submit
		$("#companyEditForm").validate({
			rules: {
				Name: {
					required: true,
					minlength: 6,
				},
				BIN: {
					required: true,
					pattern: "^[0-9]{3}-[0-9]{3}-[0-9]{3}-[0-9]{3}$"
				},
				DateOfBegin: {
					required: true,
					dateFilter: true,
					pastDate: true
				},
				Phone: {
					required: true,
					pattern: "^[0-9]-[(]?[0-9]{3}[)]?-[0-9]{3}-[0-9]{2}-[0-9]{2}$"
				}
			},
			messages: {
				Name: {
					required: "@localizer.GetValue("LabelName"): @localizer.GetValue("ValidationMessageInputRequired")",
					minlength: "@localizer.GetValue("ValidationMessageMinLenght") 6",
				},
				BIN: {
					required: "@localizer.GetValue("LabelBIN"): @localizer.GetValue("ValidationMessageInputRequired")",
					pattern: "@localizer.GetValue("LabelBIN"): @localizer.GetValue("ValidationMessageFormatError") 'XXX-XXX-XXX-XXX'"
				},
				DateOfBegin: {
					required: "@localizer.GetValue("LabelDateOfBegin"): @localizer.GetValue("ValidationMessageInputRequired")",
					dateFilter: "@localizer.GetValue("LabelDateOfBegin"): @localizer.GetValue("ValidationMessageFormatError") 'ДД.ММ.ГГГГ'",
					pastDate: "@localizer.GetValue("ValidationMessageDateNonCorrect")"
				},
				Phone: {
					required: "@localizer.GetValue("LabelPhone"): @localizer.GetValue("ValidationMessageInputRequired")",
					pattern: "@localizer.GetValue("LabelPhone"): @localizer.GetValue("ValidationMessageFormatError")'X-(XXX)-XXX-XX-XX'"
				}
			},
			submitHandler: function () {
				var data = formEdit.serializeArray();

				$.ajax({
					url: "/Company/EditCompany/",
					type: "POST",
					data: data,
					success: function (json) {
						if (json.IsSuccess == true) {
							var grid = $("#companiesGrid").data("kendoGrid");
							grid.dataSource.read();
							notification.success(json.Message);
							$("#companyEditWindow").data("kendoDialog").close();
						}
						else {
							notification.error(json.Error);
						}
					}
				});
			},
			focusInvalid: true,
			errorClass: "validationFormMessage",
			errorPlacement: function (error, element) {
				$(".validateContainer").empty();
				error.appendTo('.validateContainer');
			}
		});

		// Filters

		$("body").on("click", "#btnCompanySearch", function () {
			var grid = $("#companiesGrid").data("kendoGrid");
			grid.dataSource.read();
		});

		$("#companiesToolbar").kendoToolBar({
		});

		$("#nameFilter").kendoTextBox({});

		$("#statusesListCompanies").kendoDropDownList({
			dataTextField: "text",
			dataValueField: "value",
			dataSource: [
				{ text: "@localizer.GetValue("StatusActive")", value: 1 },
				{ text: "@localizer.GetValue("StatusDisable")", value: 2 },
			]
		});

		$("#companiesSortingTypes").kendoDropDownList({
			dataTextField: "text",
			dataValueField: "value",
			dataSource: [
				{ text: "@localizer.GetValue("SortingByName")", value: "Name" },
				{ text: "@localizer.GetValue("SortingByDateOfBegin")", value: "DateOfBegin" }
			]
		});

		// Delete
		function DeleteCompany(id) {
			document.getElementById('companiesDeleteWindow').style.display = "block";
			$("#companiesDeleteWindow").kendoDialog({
				title: false,
				modal: true,
				width: "400px",
				closable: false,
				visible: true,
				actions: [
					{
						text: "Да",
						primary: true,
						action: function () {
							$.ajax({
								url: "/Company/DeleteCompany/",
								type: "POST",
								data: { id: id },
								success: function (json) {
									if (json.IsSuccess == true) {
										var grid = $("#companiesGrid").data("kendoGrid");
										grid.dataSource.read();
										notification.success(json.Message);
									}
									else {
										notification.error(json.Error);
									}
								}
							})
						}
					},
					{ text: "Нет" }
				]
			});
		};
		// Grid

		var dataSource = new kendo.data.DataSource({
			pageSize: 20,
			transport: {
				read: {
					url: "/Company/Index",
					type: "POST",
					contentType: "application/json; charset=utf-8",
				},
				parameterMap: function (options) {
					let name = $("#nameFilter").val();
					var data = {
						CompanyName: name,
						Page: options.page,
						PageSize: options.pageSize,
						Status: $("#statusesListCompanies").val(),
						SortingType: $("#companiesSortingTypes").val()
					}
					return kendo.stringify(data);
				}
			},
			schema: {
				total: function (response) {
					if (response.length > 0)
						return response[0].TotalRows;
					else
						return 1;
				},
				model: {
					fields: {
						DateOfBegin: { type: "date" }
					}
				}
			},
			serverPaging: true,
			serverSorting: true,
		});

		$("#companiesGrid").kendoGrid({
			dataSource: dataSource,
			columns: [
				{ field: "Id", title: "Id", width: "5%", hidden: true },
				{ field: "Name", title: "@localizer.GetValue("LabelCompany")", width: "30%" },
				{ field: "Phone", title: "@localizer.GetValue("LabelPhone")", width: "10%" },
				{ field: "BIN", title: "@localizer.GetValue("LabelBIN")", width: "10%" },
				{ field: "DateOfBegin", title: "@localizer.GetValue("LabelDateOfBegin")", width: "10%", format: "{0: dd-MM-yyyy}" },
				{
					field: "Status", title: "@localizer.GetValue("LabelStatus")", width: "5%", values: [
						{ text: "@localizer.GetValue("StatusActive")", value: 1 },
						{ text: "@localizer.GetValue("StatusDisable")", value: 2 },
					]
				},

				{
					command: [
						{
							name: "Delete",
							className: "btn-destroy",
							text: "@localizer.GetValue("ButtonDelete")",
							visible: function (dataItem) { return dataItem.Status == 1 },
							click: function (e) {
								var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
								DeleteCompany(dataItem.Id);
							},
						},
						{
							name: "Activate",
							className: "btn-activate",
							text: "@localizer.GetValue("ButtonActivate")",
							visible: function (dataItem) { return dataItem.Status == 2 },
							click: function (e) {
								var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
								ActivateCompany(dataItem.Id);
							}
						},
						{
							name: "Edit",
							className: "btn-edit",
							text: "@localizer.GetValue("ButtonEdit")",
							click: function (e) {
								var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
								EditCompany(dataItem);
							},
						}
					],
					width: "30%",
				},
			],
			height: 620,
			pageable: {
				messages: {
					display: '<button type="button" id="btnCompanyInsert">@localizer.GetValue("ButtonAdd")</button>'
				}
			},
			scrollable: true,
		});
	});
</script>
