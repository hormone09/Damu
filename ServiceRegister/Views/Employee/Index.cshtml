@using ServiceRegister.Resources;

@{
	ViewBag.Title = Resource.HeadingEmployee;
}

<h2>@Resource.HeadingEmployee</h2>

<span id="employeeNotifications"></span>

<div class="container">
	<div id="employeeGrid">
		<div id="employeeToolBar">
			<p>@Resource.FilterStatus</p>
			<div id="employeeStatusesList"></div>
			<p>@Resource.FilterSorting</p>
			<div id="employeeSortingTypes" class="sorting-filter"></div>
			<p>@Resource.FilterCompany</p>
			<div id="employeeCompanyFilter" class="cmb-filter"></div>
			<p>@Resource.FilterFullName</p>
			<input type="text" name="FilterName" id="employeeNameFilter" class="filter-name"/>
			<button type="button" id="employeeSearchButton">@Resource.ButtonSearch</button>
		</div>
	</div>

	<div id="employeeFormDialog" class="submit-form-dialog">
		@Html.Partial("_PartialEmployeeForm")
	</div>

	<div id="employeeWarningWindow" class="confirmation-block">
		<h4>@Resource.DeleteWarningMessage</h4>

		<div class="button-block">
			<button type="submit" id="employeeButtonDeleteAgree" class="btn-primary">@Resource.ButtonAgree</button>
			<button type="button" id="employeeButtonDeleteAgainst" class="btn-default">@Resource.ButtonAgainst</button>
		</div>
	</div>

	<script type="text/javascript">

	$(document).ready(function () {

		var controls = {};
		controls.CurrentFieldId = {};

		$("#employeeNotifications").kendoNotification({});
		controls.Notification = $("#employeeNotifications").data("kendoNotification");

		$("#employeeFormDialog").kendoDialog({
			closable: false, visible: false, title: false, width: "600"
		});
		controls.FormDialog = $("#employeeFormDialog").data("kendoDialog");

		$("#employeeWarningWindow").kendoDialog({
			closable: false, visible: false, title: "@Resource.LabelDeleteAction"
		});
		controls.DeleteDialog = $("#employeeWarningWindow").data("kendoDialog");

		$("#employeeToolBar").kendoToolBar({});

		$("#employeeStatusesList").kendoDropDownList({
			dataTextField: "text",
			dataValueField: "value",
			dataSource: [
				{ text: "@Resource.StatusActive", value: 1 },
				{ text: "@Resource.StatusDisable", value: 2 },
			]
		});
		controls.StatusesFilter = $("#employeeStatusesList").data("kendoDropDownList");

		$("#employeeSortingTypes").kendoDropDownList({
			dataTextField: "text",
			dataValueField: "value",
			dataSource: [
				{ text: "@Resource.SortingByName", value: "FullName" },
				{ text: "@Resource.SortingByDateOfBegin", value: "DateOfBegin" },
				{ text: "@Resource.SortingByBirthdayDate", value: "BirthdayDate" },
			]
		});
		controls.SortingTypeFilter = $("#employeeSortingTypes").data("kendoDropDownList");

		$("#employeeCompanyFilter").kendoComboBox({
			placeholder: "@Resource.FilterCompany",
			dataTextField: "Name",
			dataValueField: "Id",
			filter: "contains",
			dataSource: {
				serverFiltering: true,
				transport: {
					read: {
						url: "/Company/List/",
						type: "POST",
						data: {
							CompanyName: name,
							Page: 1,
							PageSize: -1,
							Status: 0
						}
					},
				}
			}
		});
		controls.CompanyFilter = $("#employeeCompanyFilter").data("kendoComboBox");

		$("#employeeNameFilter").kendoTextBox({
			placeholder: "@Resource.PlaceholderFullName"
		});
		controls.NameFilter = $("#employeeNameFilter").data("kendoTextBox");

		controls.FormHeader = $("#employeeFormTitle");

		$("#employeeGrid").kendoGrid({
			dataSource: {
				pageSize: 20,
				transport: {
					read: {
						url: "/Employee/List",
						type: "POST",
						contentType: "application/json; charset=utf-8",
					},
					parameterMap: function (options) {
						let name = $("#employeeNameFilter").val();
						var data = {
							FullName: name,
							Page: options.page,
							PageSize: options.pageSize,
							Status: controls.StatusesFilter.value(),
							SortingType: controls.SortingTypeFilter.value(),
							CompanyId: controls.CompanyFilter.value()
						}
						return kendo.stringify(data);
					}
				},
				schema: {
					total: function (response) {
						if (response.length > 0)
							return response[0].TotalRows;
						else
							return 1;
					},
					model: {
						fields: {
							DateOfBegin: { type: "date" },
							BirthdayDate: { type: "date" }
						}
					}
				},
				page: "Page",
				serverPaging: true,
				serverSorting: true,
			},
			columns: [
				{ field: "Id", title: "Id", width: "1%", hidden: true },
				{ field: "Company.Id", title: "Id", width: "1%", hidden: true },
				{ field: "FullName", title: "@Resource.LabelFullName", width: "15%" },
				{ field: "PersonalNumber", title: "@Resource.LabelPersonalNumber", width: "10%" },
				{ field: "Phone", title: "@Resource.LabelPhone", width: "10%" },
				{ field: "Company.Name", title: "@Resource.LabelCompany", width: "10%" },
				{ field: "BirthdayDate", title: "@Resource.LabelBirthdayDate", width: "10%", format: "{0: dd.MM.yyyy}" },
				{ field: "DateOfBegin", title: "@Resource.LabelDateOfBegin", width: "10%", format: "{0: dd.MM.yyyy}" },
				{
					field: "Status", title: "@Resource.LabelStatus", width: "5%", values: [
						{ text: "@Resource.StatusActive", value: 1 },
						{ text: "@Resource.StatusDisable", value: 2 },
					]
				},
				{
					command: [
						{
							name: "Delete",
							className: "btn-destroy",
							text: "@Resource.ButtonDelete",
							visible: function (dataItem) { return dataItem.Status == 1 },
							click: function (e) {
								var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
								controls.CurrentFieldId = dataItem.Id;
								controls.DeleteDialog.open();
							},
						},
						{
							name: "Activate",
							className: "btn-activate",
							text: "@Resource.ButtonActivate",
							visible: function (dataItem) { return dataItem.Status == 2 },
							click: function (e) {
								var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

								$.ajax({
									url: "/Employee/Activate/",
									type: "POST",
									data: { id: dataItem.Id },
									success: function (json) {
										if (json.IsSuccess == true) {
											controls.Grid.dataSource.read();
											controls.Notification.success(json.Message);
										}
										else {
											controls.Notification.error(json.Message);
										}
									}
								})
							}
						},
						{
							name: "Edit",
							className: "btn-edit",
							text: "@Resource.ButtonEdit",
							click: function (e) {
								var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
								
								$("#employeeInputId").val(dataItem.Id);
								$("#employeeInputStatus").val(dataItem.Status);
								$("#employeeInputFullName").data("kendoTextBox").value(dataItem.FullName);
								$("#employeeInputPersonalNumber").data("kendoMaskedTextBox").value(dataItem.PersonalNumber);
								$("#employeeInputPhone").data("kendoMaskedTextBox").value(dataItem.Phone);
								$("#employeeCmbCompany").data("kendoComboBox").value(dataItem.Company.Id);
								$("#employeeInputBirthdayDate").data("kendoDatePicker").value(dataItem.BirthdayDate);
								$("#employeeInputDateOfBegin").data("kendoDatePicker").value(dataItem.DateOfBegin);

								controls.FormHeader.text("@Resource.EmployeeEditFormHeader");
								controls.FormDialog.open();
							},
						}
					],
					width: "18%",
				},
			],
			height: 620,
			pageable: {
				messages: {
					display: '<button type="button" id="employeeInsertButton">@Resource.ButtonAdd</button>'
				}
			},
			scrollable: true,
		});

		controls.Grid = $("#employeeGrid").data("kendoGrid");

		$("body").on("click", "#employeeInsertButton", function () {
			$("#employeeInputId").val(0);
			controls.FormHeader.text("@Resource.CompanyInsertFormHeader");
			controls.FormDialog.open();
		});

		$("body").on("click", "#employeeSearchButton", function () {
			controls.Grid.dataSource.page(1);
			controls.Grid.dataSource.read();
		});

		$("body").on("click", "#employeeButtonDeleteAgainst", function () {
			controls.DeleteDialog.close();
		});

		$("body").on("click", "#employeeButtonDeleteAgree", function () {
			$.ajax({
				url: "/Employee/Delete",
				type: "POST",
				data: { Id: controls.CurrentFieldId },
				success: function (json) {
					if (json.IsSuccess == true) {
						controls.Grid.dataSource.read();
						controls.DeleteDialog.close();
						controls.Notification.success(json.Message);
					}
					else {
						controls.Notification.error(json.Error);
					}
				}
			})
		});

		controls.Form = $("#employeeForm");
		controls.Form.kendoForm({
			orientation: "horizontal",
			visible: true,
			width: "100%",
			buttonsTemplate: "",
		});

		$("#employeeInputFullName").kendoTextBox({});

		$("#employeeInputPersonalNumber").kendoMaskedTextBox({
			mask: "000-000-000-000"
		});

		$("#employeeCmbCompany").kendoComboBox({
			placeholder: "@Resource.FilterCompany",
			dataTextField: "Name",
			dataValueField: "Id",
			filter: "contains",
			dataSource: {
				serverFiltering: true,
				transport: {
					read: {
						url: "/Company/List/",
						type: "POST",
						data: {
							CompanyName: null,
							Page: 1,
							PageSize: -1,
							Status: 0
						}
					},
				}
			}
		});

		$("#employeeInputBirthdayDate").kendoDatePicker({
			format: 'dd.MM.yyyy',
			culture: "ru-RU"
		});

		$("#employeeInputDateOfBegin").kendoDatePicker({
			format: 'dd.MM.yyyy',
			culture: "ru-RU"
		});

		$("#employeeInputPhone").kendoMaskedTextBox({
			mask: "0-(000)-000-00-00"
		});

		controls.FormValidator = $("#employeeForm").validate({
		ignore: [],
		rules: {
			FullName: {
				required: true,
				minlength: 10,
				lettersonly: true
			},
			PersonalNumber: {
				required: true,
				textMask: "^[0-9]{3}-[0-9]{3}-[0-9]{3}-[0-9]{3}$"
			},
			Company: {
				cmbIsRequired: true
			},
			Phone: {
				required: true,
				textMask: "^[0-9]-[(]?[0-9]{3}[)]?-[0-9]{3}-[0-9]{2}-[0-9]{2}$"
			},
			DateOfBegin: {
				required: true,
				dateFilter: true,
				pastDate: true
			},
			BirthdayDate: {
				required: true,
				dateFilter: true
			},
		},
		messages: {
			FullName: {
				required: "@Resource.ValidationMessageInputRequired",
				minlength: "@Resource.ValidationMessageMinLenght: 10",
				lettersonly: "@Resource.ValidationMessageOnlyCyrillic"
			},
			PersonalNumber: {
				required: "@Resource.ValidationMessageInputRequired",
				textMask: "@Resource.ValidationMessageFormatError'XXX-XXX-XXX-XXX'"
			},
			Phone: {
				required: "@Resource.ValidationMessageInputRequired",
				textMask: "@Resource.ValidationMessageFormatError'X-(XXX)-XXX-XX-XX'"
			},
			Company: {
				cmbIsRequired: "@Resource.ValidationMessageInputRequired"
			},
			BirthdayDate: {
					required: "@Resource.ValidationMessageInputRequired",
					dateFilter: "@Resource.ValidationMessageFormatError 'ДД.ММ.ГГГГ'",
					pastDate: "@Resource.ValidationMessageDateNonCorrect"
			},
			DateOfBegin: {
					required: "@Resource.ValidationMessageInputRequired",
					dateFilter: "@Resource.ValidationMessageFormatError 'ДД.ММ.ГГГГ'",
					pastDate: "@Resource.ValidationMessageDateNonCorrect"
			}
		},
			submitHandler: function (e) {
				let cmbCompany = $("#employeeCmbCompany").data("kendoComboBox").dataItem();
				let currentDate = new Date(parseInt(cmbCompany.DateOfBegin.replace(/[^0-9]/g, ''))).toLocaleDateString();
				let data = {
					Id: $("#employeeInputId").val(),
					Status: $("#employeeInputStatus").val(),
					FullName: $("#employeeInputFullName").data("kendoTextBox").value(),
					Company: { Id: cmbCompany.Id, Name: cmbCompany.Name, Phone: cmbCompany.Phone, BIN: cmbCompany.BIN, DateOfBegin: currentDate },
					PersonalNumber: $("#employeeInputPersonalNumber").data("kendoMaskedTextBox").value().replace(/[^0-9]/g, ''),
					BirthdayDate: $("#employeeInputBirthdayDate").data("kendoDatePicker").value(),
					Phone: $("#employeeInputPhone").data("kendoMaskedTextBox").value().replace(/[^0-9]/g, ''),
					DateOfBegin: $("#employeeInputDateOfBegin").data("kendoDatePicker").value()
				}

				$.ajax({
					url: data.Id == 0 ? "/Employee/Add" : "/Employee/Edit",
					type: "POST",
					contentType: "application/json; charset=utf-8",
					data: JSON.stringify(data),
					success: function (json) {
						if (json.IsSuccess) {
							controls.Form[0].reset();
							controls.FormDialog.close();
							controls.Notification.success(json.Message);
							controls.Grid.dataSource.read();
						}
						else {
							controls.Notification.error(json.Message);
						}
					}
				});
		},
		focusInvalid: true,
		errorClass: "validationFormMessage",
		errorElement: 'p',
		errorPlacement: function (error, element) {
			error.insertAfter(element.closest('div'));
		}
	});

		$("body").on("click", "#employeeFormButtonCancel", function (e) {
			controls.FormValidator.resetForm();
			controls.Form[0].reset();
		$("#employeeFormDialog").data("kendoDialog").close();
	});
	});
	</script>
